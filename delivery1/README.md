
#  First Delivery    
[![Review Assignment Due Date](https://classroom.github.com/assets/deadline-readme-button-22041afd0340ce965d47ae6ef1cefeee28c7c493a6346c4f15d667ab976d596c.svg)](https://classroom.github.com/a/n4Xu0y1X)
[![Open in Visual Studio Code](https://classroom.github.com/assets/open-in-vscode-2e0aaae1b6195c2367325f4f02e2d04e9abb55f0b24a779b69b11b9e10269abc.svg)](https://classroom.github.com/online_ide?assignment_repo_id=16930948&assignment_repo_type=AssignmentRepo)
# sio_2425_project

# Group members
- João Varela 113780
- Carolina Prata 114246
- Henrique Teixeira 114588

# How to run the project

## Installation
Activate venv
 ```bash
  python3 -m venv venv # create venv
  source venv/bin/activate # activate venv
  ```
Install requirements
```bash
pip install -r requirements.txt
```
  
## Run the tests
./test.sh

## Run the project
+ activate app
```bash
python3 repository.py
```
+ execute the commands
```bash 
./rep_create_org DETI Ric Henrique henriqueft04@ua.pt keys/admin_credentials.json
```


# Security Guidelines and Features Implementation

## Step 1: Subject Credential Creation (Key Pair Generation)
### rep_subject_credentials < password> < credentials file>
+ Generates a subject key pair.
  + The private key is deterministically derived from the password and a salt.
  + The public key is generated from the private key.
- The credentials_file has the following structure:
  - **salt**: The salt used to generate the private key, which is used to generate the public key.
    - The private key isn’t stored in the file because it is generated from the password and the salt.
  - **public key**: The public key is stored in the PEM format (UTF-8 decoded).
- **Security Note**: The private key is not stored, making the security dependent on the combination of the password and salt.

---

## Step 2: Organization Creation
### rep_create_org < organization> < username> < name> < email> < public_key_file>
- The organization is created using the public key.
- Access Control Lists (ACLs) can be managed by the admin to assign different roles in the future.

---

## Step 3: Session Creation
### rep_create_session < organization> < username> < password> < credentials_file> < session_file>
- A **session** is created for secure interactions with the repository.
- **ECDH Shared Key Generation**:
  - **Client Side**:
    - Regenerates the private key using the password and salt from the credentials file.
  - **Server Side**:
    - Uses the organization's public key to compute a shared secret key using Elliptic Curve Diffie-Hellman (ECDH).
- **Session Key Derivation**:
  - Shared secret key is used to generate a session key via HKDF.
  - A salt ensures each session key is unique.
- The session_file has the following structure:
  - **session_id**: Generated by the server.
  - **session_key**: The derived session key (UTF-8 decoded PEM format).
  - **organization**: Name of the organization.
  - **username**: User’s name.
  - **expiration**: Expiration date for the session.

---

## Step 4: Document Upload
### rep_add_doc < session_file> < document_name> < file>
+ **Random File Key Generation**:
  - A symmetric key (file_key) of 32 bytes is generated for AES-GCM encryption.
+ **File Encryption**:
  - AES-GCM encrypts the document, producing:
    - **Ciphertext**: The encrypted document.
    - **IV (Initialization Vector)**: A random nonce.
    - **Tag**: Authentication tag for integrity verification.
+ **File Handle Calculation**:
  - A cryptographic hash (e.g., SHA-256) is computed for file integrity verification.
+ **File Key Encryption**:
  - ECC encrypts the file_key using ECDH and HKDF-derived symmetric encryption.

---

## Step 5: Document Download
### rep_get_file <file_handle> [file]
+ **Session Establishment**:
  - The user logs in with DOC_READ permissions.
+ **Metadata Retrieval**:
  - Public and restricted metadata, including the encrypted file key and IV, are fetched securely.
+ **File Decryption**:
  - Shared secrets derived using the client’s private key and the organization’s public key decrypt the file key.
  - AES-GCM decrypts the file using the decrypted file key.
+ **Integrity Verification**:
  - File handle is recalculated and matched to ensure the file's integrity.

---

## Step 6: Document Deletion
### rep_delete_doc <session_file> <document_name>
+ **Permissions Check**:
  - Requires DOC_DELETE permission.
+ **Metadata Update**:
  - Removes the file handle and updates metadata with the deleter’s information.
+ **Confidentiality**:
  - File handle and encryption key are securely sent to the client for potential future use.

---

## Step 7: Add Subjects to Organizations
### rep_add_subject < session_file> < username> < name> < email> < credentials_file>
+ **Subject Creation**:
  - Associates a new subject with an organization.
+ **Public Key Storage**:
  - Uses a public key from the credentials file to add the subject securely.
+ **Role Management**:
  - Enables role assignment within the organization.

---

## Step 8: List Subjects
### rep_list_subjects <session_file> [username]
+ **Subject Listing**:
  - Displays all subjects in the organization.
+ **User Details**:
  - Optionally fetches details for a specific user.

---

## Step 9: List Organizations
### rep_list_orgs
+ **Organization Listing**:
  - Retrieves all organizations managed by the repository.

---

## Step 10: Suspend Subject
### rep_suspend_subject < session_file> < username>
+ **User Suspension**:
  - Updates the user status to "suspended."

---

## Step 11: Activate Subject
### rep_activate_subject < session_file> < username>
+ **User Reactivation**:
  - Updates the user status to "active."

---

## Step 12: List Documents
### rep_list_docs <session_file> [-s username] [-d nt/ot/et date]
+ **Filtered Listing**:
  - Documents can be listed with optional filters by username or date.
  - Filters:
    - **nt**: Not after date.
    - **ot**: Not before date.
    - **et**: Exactly on date.

---

## Step 13: Retrieve Document Metadata
### rep_get_doc_metadata < session_file> < document_name>
+ **Metadata Fetching**:
  - Retrieves metadata for a specific document.
---

## Step 14: Decrypt File
### rep_decrypt_file < encrypted_file> < metadata_file>
+ **File Decryption**:
  - Decrypts a file using provided encryption metadata.
  - Outputs the decrypted content securely.
- not properly implemented